<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<body>
    <div th:fragment="cart-sidebar">
        <!-- Overlay -->
        <div class="cart-overlay" id="cartOverlay"></div>

        <!-- Sidebar del carrito -->
        <aside class="cart-sidebar" id="cartSidebar">
            <div class="cart-header">
                <h3>üõí Mi Carrito</h3>
                <button class="cart-close" id="cartClose">‚úï</button>
            </div>

            <div class="cart-content">
                <div class="cart-items" id="cartItems">
                    <!-- Los items del carrito se cargar√°n aqu√≠ -->
                    <div class="empty-cart">
                        <p>Tu carrito est√° vac√≠o</p>
                        <a href="/customer/products" class="btn btn-primary">Comenzar a comprar</a>
                    </div>
                </div>

                <div class="cart-summary" id="cartSummary" style="display: none;">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="cartSubtotal">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Env√≠o:</span>
                        <span id="cartShipping">$0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="cartTotal">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="cart-footer" id="cartFooter" style="display: none;">
                <a href="/user/cart" class="btn btn-secondary btn-block">
                    Ver Carrito Completo
                </a>
                <a href="/user/checkout" class="btn btn-primary btn-block">
                    Finalizar Compra
                </a>
            </div>
        </aside>

        <style>
            .cart-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1998;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }

            .cart-overlay.active {
                opacity: 1;
                visibility: visible;
            }

            .cart-sidebar {
                position: fixed;
                top: 0;
                right: -400px;
                width: 100%;
                max-width: 400px;
                height: 100%;
                background: white;
                z-index: 1999;
                transition: right 0.3s ease;
                display: flex;
                flex-direction: column;
                box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .cart-sidebar.active {
                right: 0;
            }

            .cart-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1.5rem;
                border-bottom: 1px solid #e9ecef;
            }

            .cart-header h3 {
                margin: 0;
                color: #333;
            }

            .cart-close {
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0.5rem;
                transition: color 0.3s ease;
            }

            .cart-close:hover {
                color: #ff4444;
            }

            .cart-content {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
            }

            .cart-items {
                min-height: 200px;
            }

            .empty-cart {
                text-align: center;
                padding: 2rem 1rem;
                color: #666;
            }

            .empty-cart .btn {
                margin-top: 1rem;
            }

            .cart-item {
                display: flex;
                gap: 1rem;
                padding: 1rem;
                border-bottom: 1px solid #f0f0f0;
                align-items: center;
            }

            .cart-item:last-child {
                border-bottom: none;
            }

            .cart-item-image {
                width: 60px;
                height: 60px;
                border-radius: 8px;
                overflow: hidden;
                flex-shrink: 0;
            }

            .cart-item-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .cart-item-details {
                flex: 1;
            }

            .cart-item-name {
                font-weight: 500;
                margin-bottom: 0.25rem;
                color: #333;
            }

            .cart-item-price {
                color: #667eea;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

            .cart-item-actions {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .quantity-btn {
                width: 30px;
                height: 30px;
                border: 1px solid #ddd;
                background: white;
                border-radius: 4px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
            }

            .quantity-btn:hover {
                background: #f5f5f5;
            }

            .quantity-display {
                min-width: 30px;
                text-align: center;
                font-weight: 500;
            }

            .remove-btn {
                background: none;
                border: none;
                color: #ff4444;
                cursor: pointer;
                padding: 0.5rem;
                margin-left: 0.5rem;
                transition: color 0.3s ease;
            }

            .remove-btn:hover {
                color: #cc0000;
            }

            .cart-summary {
                padding: 1.5rem;
                border-top: 1px solid #e9ecef;
                background: #f8f9fa;
                border-radius: 8px;
                margin-top: 1rem;
            }

            .summary-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.5rem;
            }

            .summary-row.total {
                font-weight: 600;
                font-size: 1.1rem;
                color: #333;
                border-top: 1px solid #ddd;
                padding-top: 0.5rem;
                margin-top: 0.5rem;
            }

            .cart-footer {
                padding: 1.5rem;
                border-top: 1px solid #e9ecef;
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            .btn-block {
                width: 100%;
                text-align: center;
            }

            .btn {
                display: inline-block;
                padding: 0.75rem 1.5rem;
                border: none;
                border-radius: 6px;
                text-decoration: none;
                text-align: center;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .btn-primary {
                background: #667eea;
                color: white;
            }

            .btn-primary:hover {
                background: #5a6fd8;
                transform: translateY(-1px);
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn-secondary:hover {
                background: #5a6268;
                transform: translateY(-1px);
            }

            /* Responsive */
            @media (max-width: 480px) {
                .cart-sidebar {
                    max-width: 100%;
                }
            }
        </style>

        <script>
            class CartSidebar {
                constructor() {
                    this.initialized = false;
                    this.init();
                }

                init() {
                    if (this.initialized) return;

                    this.setupEventListeners();
                    this.loadCartItems();
                    this.initialized = true;

                    console.log('üõí CartSidebar inicializado');
                }

                setupEventListeners() {
                    // Toggle sidebar
                    window.addEventListener('toggleCartSidebar', () => {
                        this.toggleSidebar();
                    });

                    // Cerrar sidebar
                    const cartClose = document.getElementById('cartClose');
                    const cartOverlay = document.getElementById('cartOverlay');

                    cartClose?.addEventListener('click', () => {
                        this.closeSidebar();
                    });

                    cartOverlay?.addEventListener('click', () => {
                        this.closeSidebar();
                    });

                    // Escuchar actualizaciones del carrito - MEJORADO
                    window.addEventListener('cartUpdated', () => {
                        console.log('üîÑ CartSidebar recibi√≥ evento cartUpdated');
                        this.loadCartItems();
                    });

                    // NUEVO: Escuchar evento espec√≠fico de orden creada
                    window.addEventListener('orderCreated', () => {
                        console.log('üîÑ CartSidebar recibi√≥ evento orderCreated');
                        this.loadCartItems();
                    });

                    // NUEVO: Actualizar cuando la p√°gina gana foco (cuando el usuario vuelve de otra pesta√±a)
                    document.addEventListener('visibilitychange', () => {
                        if (!document.hidden) {
                            console.log('üìÑ P√°gina visible, actualizando carrito...');
                            this.loadCartItems();
                        }
                    });

                    // NUEVO: Actualizar peri√≥dicamente (cada 30 segundos) por si hay cambios
                    setInterval(() => {
                        this.loadCartItems();
                    }, 30000);

                    // Prevenir cierre al hacer clic dentro del sidebar
                    const cartSidebar = document.getElementById('cartSidebar');
                    cartSidebar?.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                }

                toggleSidebar() {
                    const sidebar = document.getElementById('cartSidebar');
                    const overlay = document.getElementById('cartOverlay');

                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');

                    if (sidebar.classList.contains('active')) {
                        this.loadCartItems();
                    }
                }

                closeSidebar() {
                    const sidebar = document.getElementById('cartSidebar');
                    const overlay = document.getElementById('cartOverlay');

                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                }

                async loadCartItems() {
                    try {
                        console.log('üîÑ CartSidebar cargando items...');
                        const response = await fetch('/api/customer/cart');

                        if (response.ok) {
                            const cartData = await response.json();
                            console.log('‚úÖ Carrito cargado:', cartData);
                            this.displayCartItems(cartData);

                            // NUEVO: Actualizar tambi√©n el contador del header
                            this.updateHeaderCartCount(cartData);
                        } else {
                            console.warn('‚ö†Ô∏è Error en respuesta del carrito');
                            this.displayCartItems({ items: [] });
                        }
                    } catch (error) {
                        console.error('‚ùå Error loading cart:', error);
                        this.displayCartItems({ items: [] });
                    }
                }

                displayCartItems(cartData) {
                    const cartItemsContainer = document.getElementById('cartItems');
                    const cartSummary = document.getElementById('cartSummary');
                    const cartFooter = document.getElementById('cartFooter');

                    if (!cartData.items || cartData.items.length === 0) {
                        console.log('üõí Carrito vac√≠o detectado');
                        cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <p>Tu carrito est√° vac√≠o</p>
                        <a href="/customer/products" class="btn btn-primary">Comenzar a comprar</a>
                    </div>
                `;
                        cartSummary.style.display = 'none';
                        cartFooter.style.display = 'none';

                        // Asegurar que el header tambi√©n se actualice
                        this.updateHeaderCartCount({ items: [] });
                        return;
                    }

                    console.log(`üõí Mostrando ${cartData.items.length} items en el carrito`);

                    // Mostrar items
                    cartItemsContainer.innerHTML = cartData.items.map(item => `
                <div class="cart-item" data-product-id="${item.productId}">
                    <div class="cart-item-image">
                        <img src="${item.productImage}" 
                             alt="${item.productName}"
                             onerror="this.src='/images/default-product.png'">
                    </div>
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.productName}</div>
                        <div class="cart-item-price">$${item.productPrice.toFixed(2)}</div>
                        <div class="cart-item-actions">
                            <button class="quantity-btn decrease" data-product-id="${item.productId}">-</button>
                            <span class="quantity-display">${item.quantity}</span>
                            <button class="quantity-btn increase" data-product-id="${item.productId}">+</button>
                            <button class="remove-btn" data-product-id="${item.productId}" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');

                    // Actualizar resumen
                    this.updateCartSummary(cartData);

                    // Mostrar resumen y footer
                    cartSummary.style.display = 'block';
                    cartFooter.style.display = 'flex';

                    // Agregar event listeners a los botones
                    this.addCartItemEventListeners();
                }

                updateCartSummary(cartData) {
                    const subtotal = cartData.totalAmount || cartData.items.reduce((sum, item) =>
                        sum + (item.productPrice * item.quantity), 0
                    );

                    const shipping = subtotal > 50 ? 0 : 5.99; // Env√≠o gratis sobre $50
                    const total = subtotal + shipping;

                    document.getElementById('cartSubtotal').textContent = `$${subtotal.toFixed(2)}`;
                    document.getElementById('cartShipping').textContent = shipping === 0 ? 'Gratis' : `$${shipping.toFixed(2)}`;
                    document.getElementById('cartTotal').textContent = `$${total.toFixed(2)}`;
                }

                // NUEVO: M√©todo para actualizar el contador del header
                updateHeaderCartCount(cartData) {
                    const totalItems = cartData.items ?
                        cartData.items.reduce((sum, item) => sum + item.quantity, 0) : 0;

                    const headerCartCount = document.getElementById('headerCartCount');
                    if (headerCartCount) {
                        headerCartCount.textContent = totalItems;
                        console.log(`üî¢ Contador del header actualizado: ${totalItems}`);
                    }

                    // Tambi√©n actualizar el t√≠tulo si existe
                    const cartItemsCountElement = document.getElementById('cartItemsCount');
                    if (cartItemsCountElement) {
                        cartItemsCountElement.textContent = `${totalItems} ${totalItems === 1 ? 'producto' : 'productos'}`;
                    }
                }

                addCartItemEventListeners() {
                    // Botones de incrementar/decrementar cantidad
                    document.querySelectorAll('.quantity-btn.increase').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const productId = e.target.dataset.productId;
                            this.updateCartItemQuantity(productId, 'increase');
                        });
                    });

                    document.querySelectorAll('.quantity-btn.decrease').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const productId = e.target.dataset.productId;
                            this.updateCartItemQuantity(productId, 'decrease');
                        });
                    });

                    // Botones de eliminar
                    document.querySelectorAll('.remove-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const productId = e.target.dataset.productId;
                            this.removeCartItem(productId);
                        });
                    });
                }

                async updateCartItemQuantity(productId, action) {
                    try {
                        // Obtener cantidad actual
                        const currentItem = document.querySelector(`[data-product-id="${productId}"]`);
                        const quantityDisplay = currentItem?.querySelector('.quantity-display');
                        let currentQuantity = parseInt(quantityDisplay?.textContent || 1);

                        // Calcular nueva cantidad
                        let newQuantity = action === 'increase' ? currentQuantity + 1 : currentQuantity - 1;

                        if (newQuantity < 1) {
                            this.removeCartItem(productId);
                            return;
                        }

                        // Actualizar en el backend
                        const response = await fetch(`/api/customer/cart/items/${productId}?quantity=${newQuantity}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            window.dispatchEvent(new CustomEvent('cartUpdated'));
                        } else {
                            throw new Error('Error al actualizar cantidad');
                        }
                    } catch (error) {
                        console.error('Error updating cart item:', error);
                        this.showNotification('Error al actualizar cantidad', 'error');
                    }
                }

                async removeCartItem(productId) {
                    try {
                        const response = await fetch(`/api/customer/cart/items/${productId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            window.dispatchEvent(new CustomEvent('cartUpdated'));
                            this.showNotification('Producto eliminado del carrito', 'success');
                        } else {
                            throw new Error('Error al eliminar producto');
                        }
                    } catch (error) {
                        console.error('Error removing cart item:', error);
                        this.showNotification('Error al eliminar producto', 'error');
                    }
                }

                showNotification(message, type = 'info') {
                    const notification = document.createElement('div');
                    notification.className = `notification notification-${type}`;
                    notification.textContent = message;
                    notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 6px;
                color: white;
                z-index: 2000;
                font-weight: 500;
            `;

                    if (type === 'success') {
                        notification.style.background = '#28a745';
                    } else if (type === 'error') {
                        notification.style.background = '#dc3545';
                    } else {
                        notification.style.background = '#17a2b8';
                    }

                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            }

            // Inicializar cuando el DOM est√© listo
            document.addEventListener('DOMContentLoaded', () => {
                // Crear instancia global para acceso desde otras p√°ginas
                window.cartSidebar = new CartSidebar();

                // NUEVO: Forzar una actualizaci√≥n despu√©s de un tiempo por si la p√°gina se carg√≥ despu√©s de crear una orden
                setTimeout(() => {
                    console.log('‚è∞ Actualizaci√≥n programada del carrito');
                    window.cartSidebar?.loadCartItems();
                }, 1000);

                // NUEVO: Actualizar tambi√©n cuando la p√°gina se carga completamente
                window.addEventListener('load', () => {
                    console.log('üìÑ P√°gina completamente cargada, actualizando carrito...');
                    window.cartSidebar?.loadCartItems();
                });
            });

            window.refreshCart = function () {
                console.log('üîÑ Forzando actualizaci√≥n del carrito...');
                window.cartSidebar?.loadCartItems();
            };
        </script>
    </div>
</body>

</html>