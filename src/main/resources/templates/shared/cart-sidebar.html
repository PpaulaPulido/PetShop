<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<body>
    <div th:fragment="cart-sidebar">
        <div class="cart-overlay" id="cartOverlay"></div>

        <aside class="cart-sidebar" id="cartSidebar">
            <div class="cart-header">
                <h3>üõí Mi Carrito</h3>
                <button class="cart-close" id="cartClose">‚úï</button>
            </div>

            <div class="cart-content">
                <div class="cart-items" id="cartItems">
                    <div class="empty-cart">
                        <p>Tu carrito est√° vac√≠o</p>
                        <a href="/customer/products" class="btn btn-primary">Comenzar a comprar</a>
                    </div>
                </div>

                <div class="cart-summary" id="cartSummary" style="display: none;">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="cartSubtotal">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Env√≠o:</span>
                        <span id="cartShipping">$0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="cartTotal">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="cart-footer" id="cartFooter" style="display: none;">
                <a href="/user/cart" class="btn btn-secondary btn-block">
                    Ver Carrito Completo
                </a>
                <a href="/user/checkout" class="btn btn-primary btn-block">
                    Finalizar Compra
                </a>
            </div>
        </aside>

        <script>
            class CartSidebar {
                constructor() {
                    this.initialized = false;
                    this.init();
                }

                init() {
                    if (this.initialized) return;

                    this.setupEventListeners();
                    this.loadCartItems();
                    this.initialized = true;

                }

                setupEventListeners() {
                    // Toggle sidebar
                    window.addEventListener('toggleCartSidebar', () => {
                        this.toggleSidebar();
                    });

                    // Cerrar sidebar
                    const cartClose = document.getElementById('cartClose');
                    const cartOverlay = document.getElementById('cartOverlay');

                    cartClose?.addEventListener('click', () => {
                        this.closeSidebar();
                    });

                    cartOverlay?.addEventListener('click', () => {
                        this.closeSidebar();
                    });

                    // Escuchar actualizaciones del carrito 
                    window.addEventListener('cartUpdated', () => {
                        this.loadCartItems();
                    });

                    // Escuchar evento espec√≠fico de orden creada
                    window.addEventListener('orderCreated', () => {
                        this.loadCartItems();
                    });

                    //Actualizar cuando la p√°gina gana foco (cuando el usuario vuelve de otra pesta√±a)
                    document.addEventListener('visibilitychange', () => {
                        if (!document.hidden) {
                            this.loadCartItems();
                        }
                    });

                    //Actualizar peri√≥dicamente (cada 30 segundos) por si hay cambios
                    setInterval(() => {
                        this.loadCartItems();
                    }, 30000);

                    // Prevenir cierre al hacer clic dentro del sidebar
                    const cartSidebar = document.getElementById('cartSidebar');
                    cartSidebar?.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                }

                toggleSidebar() {
                    const sidebar = document.getElementById('cartSidebar');
                    const overlay = document.getElementById('cartOverlay');

                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');

                    if (sidebar.classList.contains('active')) {
                        this.loadCartItems();
                    }
                }

                closeSidebar() {
                    const sidebar = document.getElementById('cartSidebar');
                    const overlay = document.getElementById('cartOverlay');

                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                }

                async loadCartItems() {
                    try {
                        const response = await fetch('/api/customer/cart');

                        if (response.ok) {
                            const cartData = await response.json();
                            this.displayCartItems(cartData);

                            //Actualizar tambi√©n el contador del header
                            this.updateHeaderCartCount(cartData);
                        } else {
                            this.displayCartItems({ items: [] });
                        }
                    } catch (error) {
                        this.displayCartItems({ items: [] });
                    }
                }

                displayCartItems(cartData) {
                    const cartItemsContainer = document.getElementById('cartItems');
                    const cartSummary = document.getElementById('cartSummary');
                    const cartFooter = document.getElementById('cartFooter');

                    if (!cartData.items || cartData.items.length === 0) {
                        console.log('üõí Carrito vac√≠o detectado');
                        cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <p>Tu carrito est√° vac√≠o</p>
                        <a href="/customer/products" class="btn btn-primary">Comenzar a comprar</a>
                    </div>
                `;
                        cartSummary.style.display = 'none';
                        cartFooter.style.display = 'none';

                        this.updateHeaderCartCount({ items: [] });
                        return;
                    }


                    // Mostrar items
                    cartItemsContainer.innerHTML = cartData.items.map(item => `
                <div class="cart-item" data-product-id="${item.productId}">
                    <div class="cart-item-image">
                        <img src="${item.productImage}" 
                             alt="${item.productName}"
                             onerror="this.src='/images/default-product.png'">
                    </div>
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.productName}</div>
                        <div class="cart-item-price">$${item.productPrice.toFixed(2)}</div>
                        <div class="cart-item-actions">
                            <button class="quantity-btn decrease" data-product-id="${item.productId}">-</button>
                            <span class="quantity-display">${item.quantity}</span>
                            <button class="quantity-btn increase" data-product-id="${item.productId}">+</button>
                            <button class="remove-btn" data-product-id="${item.productId}" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');

                    // Actualizar resumen
                    this.updateCartSummary(cartData);

                    // Mostrar resumen y footer
                    cartSummary.style.display = 'block';
                    cartFooter.style.display = 'flex';

                    // Agregar event listeners a los botones
                    this.addCartItemEventListeners();
                }

                updateCartSummary(cartData) {
                    const subtotal = cartData.totalAmount || cartData.items.reduce((sum, item) =>
                        sum + (item.productPrice * item.quantity), 0
                    );

                    const shipping = subtotal > 50000 ? 0 : 15000; // Env√≠o gratis sobre $50
                    const total = subtotal + shipping;

                    document.getElementById('cartSubtotal').textContent = `$${subtotal.toFixed(2)}`;
                    document.getElementById('cartShipping').textContent = shipping === 0 ? 'Gratis' : `$${shipping.toFixed(2)}`;
                    document.getElementById('cartTotal').textContent = `$${total.toFixed(2)}`;
                }

                //M√©todo para actualizar el contador del header
                updateHeaderCartCount(cartData) {
                    const totalItems = cartData.items ?
                        cartData.items.reduce((sum, item) => sum + item.quantity, 0) : 0;

                    const headerCartCount = document.getElementById('headerCartCount');
                    if (headerCartCount) {
                        headerCartCount.textContent = totalItems;
                        console.log(`üî¢ Contador del header actualizado: ${totalItems}`);
                    }

                    // Tambi√©n actualizar el t√≠tulo si existe
                    const cartItemsCountElement = document.getElementById('cartItemsCount');
                    if (cartItemsCountElement) {
                        cartItemsCountElement.textContent = `${totalItems} ${totalItems === 1 ? 'producto' : 'productos'}`;
                    }
                }

                addCartItemEventListeners() {
                    // Botones de incrementar/decrementar cantidad
                    document.querySelectorAll('.quantity-btn.increase').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const productId = e.target.dataset.productId;
                            this.updateCartItemQuantity(productId, 'increase');
                        });
                    });

                    document.querySelectorAll('.quantity-btn.decrease').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const productId = e.target.dataset.productId;
                            this.updateCartItemQuantity(productId, 'decrease');
                        });
                    });

                    // Botones de eliminar
                    document.querySelectorAll('.remove-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const productId = e.target.dataset.productId;
                            this.removeCartItem(productId);
                        });
                    });
                }

                async updateCartItemQuantity(productId, action) {
                    try {
                        // Obtener cantidad actual
                        const currentItem = document.querySelector(`[data-product-id="${productId}"]`);
                        const quantityDisplay = currentItem?.querySelector('.quantity-display');
                        let currentQuantity = parseInt(quantityDisplay?.textContent || 1);

                        // Calcular nueva cantidad
                        let newQuantity = action === 'increase' ? currentQuantity + 1 : currentQuantity - 1;

                        if (newQuantity < 1) {
                            this.removeCartItem(productId);
                            return;
                        }

                        // Actualizar en el backend
                        const response = await fetch(`/api/customer/cart/items/${productId}?quantity=${newQuantity}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            window.dispatchEvent(new CustomEvent('cartUpdated'));
                        } else {
                            throw new Error('Error al actualizar cantidad');
                        }
                    } catch (error) {
                        this.showNotification('Error al actualizar cantidad', 'error');
                    }
                }

                async removeCartItem(productId) {
                    try {
                        const response = await fetch(`/api/customer/cart/items/${productId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            window.dispatchEvent(new CustomEvent('cartUpdated'));
                            this.showNotification('Producto eliminado del carrito', 'success');
                        } else {
                            throw new Error('Error al eliminar producto');
                        }
                    } catch (error) {
                        this.showNotification('Error al eliminar producto', 'error');
                    }
                }

                showNotification(message, type = 'info') {
                    const notification = document.createElement('div');
                    notification.className = `notification notification-${type}`;
                    notification.textContent = message;
                    notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 6px;
                color: white;
                z-index: 2000;
                font-weight: 500;
            `;

                    if (type === 'success') {
                        notification.style.background = '#28a745';
                    } else if (type === 'error') {
                        notification.style.background = '#dc3545';
                    } else {
                        notification.style.background = '#17a2b8';
                    }

                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            }

            // Inicializar cuando el DOM est√© listo
            document.addEventListener('DOMContentLoaded', () => {
                // Crear instancia global para acceso desde otras p√°ginas
                window.cartSidebar = new CartSidebar();

                // Forzar una actualizaci√≥n despu√©s de un tiempo por si la p√°gina se carg√≥ despu√©s de crear una orden
                setTimeout(() => {
                    window.cartSidebar?.loadCartItems();
                }, 1000);

                //Actualizar tambi√©n cuando la p√°gina se carga completamente
                window.addEventListener('load', () => {
                    window.cartSidebar?.loadCartItems();
                });
            });

            window.refreshCart = function () {
                window.cartSidebar?.loadCartItems();
            };
        </script>
    </div>
</body>

</html>