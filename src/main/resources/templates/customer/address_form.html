<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit ? 'Editar Direcci√≥n - PetLuz' : 'Nueva Direcci√≥n - PetLuz'}">Nueva Direcci√≥n - PetLuz</title>
    <link rel="stylesheet" th:href="@{/css/base_customer.css}">
    <link rel="stylesheet" th:href="@{/css/customer_address_form.css}">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <!-- Header -->
    <div th:replace="shared/header :: header"></div>

    <!-- Sidebar del carrito -->
    <div th:replace="shared/cart-sidebar :: cart-sidebar"></div>

    <main class="address-form-container">
        <div class="container">
            <!-- Navegaci√≥n -->
            <nav class="breadcrumb">
                <a href="/user/dashboard">Mi Cuenta</a>
                <span class="separator">/</span>
                <a href="/user/addresses">Mis Direcciones</a>
                <span class="separator">/</span>
                <span class="current" th:text="${isEdit ? 'Editar Direcci√≥n' : 'Nueva Direcci√≥n'}">Nueva Direcci√≥n</span>
            </nav>

            <!-- Header del formulario -->
            <section class="form-header">
                <div class="header-content">
                    <h1 th:text="${isEdit ? '‚úèÔ∏è Editar Direcci√≥n' : 'üìç Nueva Direcci√≥n'}">üìç Nueva Direcci√≥n</h1>
                    <p>Completa la informaci√≥n de tu direcci√≥n en Colombia</p>
                </div>
                <a href="/user/addresses" class="btn btn-outline">
                    ‚Üê Volver a Direcciones
                </a>
            </section>

            <!-- Formulario -->
            <div class="form-layout">
                <!-- Columna del formulario -->
                <div class="form-column">
                    <form id="addressForm" class="address-form">
                        <input type="hidden" id="addressId" th:value="${address?.id}">
                        
                        <!-- Informaci√≥n b√°sica -->
                        <section class="form-section">
                            <h2>üìù Informaci√≥n B√°sica</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="addressType">Tipo de Direcci√≥n *</label>
                                    <select id="addressType" name="addressType" required>
                                        <option value="">Selecciona el tipo</option>
                                        <option value="HOME" th:selected="${address?.addressType == 'HOME'}">Casa</option>
                                        <option value="APARTMENT" th:selected="${address?.addressType == 'APARTMENT'}">Apartamento</option>
                                        <option value="WORK" th:selected="${address?.addressType == 'WORK'}">Trabajo</option>
                                        <option value="OFFICE" th:selected="${address?.addressType == 'OFFICE'}">Oficina</option>
                                        <option value="OTHER" th:selected="${address?.addressType == 'OTHER'}">Otro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="contactName">Nombre de Contacto *</label>
                                    <input type="text" id="contactName" name="contactName" 
                                           th:value="${address?.contactName}"
                                           placeholder="Ej: Juan P√©rez" required maxlength="100">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="contactPhone">Tel√©fono de Contacto *</label>
                                    <input type="tel" id="contactPhone" name="contactPhone" 
                                           th:value="${address?.contactPhone}"
                                           placeholder="Ej: 3001234567" required pattern="[0-9]{10}">
                                    <small>10 d√≠gitos sin espacios ni caracteres especiales</small>
                                </div>
                            </div>
                        </section>

                        <!-- B√∫squeda de direcci√≥n -->
                        <section class="form-section">
                            <h2>üîç Buscar Direcci√≥n</h2>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="addressSearch">Buscar Direcci√≥n en el Mapa *</label>
                                    <div class="search-container">
                                        <input type="text" id="addressSearch" 
                                               placeholder="Ej: Calle 100 # 15-20, Bogot√°" 
                                               class="search-input">
                                        <button type="button" id="searchBtn" class="search-btn">üîç</button>
                                    </div>
                                    <small>Escribe tu direcci√≥n completa y selecci√≥nala en el mapa</small>
                                </div>
                            </div>
                        </section>

                        <!-- Ubicaci√≥n en Colombia -->
                        <section class="form-section">
                            <h2>üá®üá¥ Ubicaci√≥n en Colombia</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="department">Departamento *</label>
                                    <select id="department" name="department" required>
                                        <option value="">Selecciona un departamento</option>
                                        <!-- Los departamentos se cargar√°n din√°micamente -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="city">Ciudad/Municipio *</label>
                                    <select id="city" name="city" required disabled>
                                        <option value="">Primero selecciona un departamento</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="zipCode">C√≥digo Postal</label>
                                    <input type="text" id="zipCode" name="zipCode" 
                                           th:value="${address?.zipCode}"
                                           placeholder="Ej: 110011" pattern="[0-9]{6}">
                                    <small>6 d√≠gitos del c√≥digo postal (opcional)</small>
                                </div>
                            </div>
                        </section>

                        <!-- Direcci√≥n detallada -->
                        <section class="form-section">
                            <h2>üè† Direcci√≥n Detallada</h2>
                            
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="addressLine1">Direcci√≥n Principal *</label>
                                    <input type="text" id="addressLine1" name="addressLine1" 
                                           th:value="${address?.addressLine1}"
                                           placeholder="Ej: Calle 100 # 15-20" required>
                                    <small>Direcci√≥n completa que se mostrar√° en los pedidos</small>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="addressLine2">Barrio/Urbanizaci√≥n/Complemento</label>
                                    <input type="text" id="addressLine2" name="addressLine2" 
                                           th:value="${address?.addressLine2}"
                                           placeholder="Ej: Chapinero, Unidad Residencial...">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="landmark">Punto de Referencia</label>
                                    <input type="text" id="landmark" name="landmark" 
                                           th:value="${address?.landmark}"
                                           placeholder="Ej: Frente al centro comercial, cerca de...">
                                </div>
                            </div>
                        </section>

                        <!-- Instrucciones de entrega -->
                        <section class="form-section">
                            <h2>üìã Instrucciones de Entrega</h2>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="deliveryInstructions">Instrucciones Especiales (Opcional)</label>
                                    <textarea id="deliveryInstructions" name="deliveryInstructions" 
                                              th:text="${address?.deliveryInstructions}"
                                              placeholder="Ej: Timbre 2 veces, dejar en porter√≠a, llamar antes de llegar..."
                                              rows="3" maxlength="500"></textarea>
                                    <small class="char-counter">0/500 caracteres</small>
                                </div>
                            </div>
                        </section>

                        <!-- Opciones -->
                        <section class="form-section">
                            <div class="form-options">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="isPrimary" name="isPrimary" 
                                           th:checked="${address?.isPrimary}">
                                    <span class="checkmark"></span>
                                    Establecer como direcci√≥n principal
                                </label>
                            </div>
                        </section>

                        <!-- Botones de acci√≥n -->
                        <section class="form-actions">
                            <a href="/user/addresses" class="btn btn-secondary">
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <span th:text="${isEdit ? 'Actualizar Direcci√≥n' : 'Crear Direcci√≥n'}">Crear Direcci√≥n</span>
                            </button>
                        </section>
                    </form>
                </div>

                <!-- Columna del mapa -->
                <div class="map-column">
                    <section class="map-section">
                        <h2>üó∫Ô∏è Verificaci√≥n en el Mapa</h2>
                        <div class="map-container">
                            <div id="addressMap"></div>
                            <div class="map-instructions">
                                <p><strong>Instrucciones:</strong></p>
                                <ol>
                                    <li>Escribe tu direcci√≥n en el buscador</li>
                                    <li>Selecciona la opci√≥n correcta</li>
                                    <li>Verifica la ubicaci√≥n en el mapa</li>
                                    <li>Arrastra el marcador para ajustar la posici√≥n</li>
                                </ol>
                            </div>
                        </div>
                        <div class="map-coordinates" id="mapCoordinates">
                            <p><strong>Coordenadas:</strong> <span id="coordinatesText">No seleccionadas</span></p>
                        </div>
                    </section>

                    <!-- Previsualizaci√≥n -->
                    <section class="preview-section">
                        <h2>üëÄ Previsualizaci√≥n</h2>
                        <div class="address-preview" id="addressPreview">
                            <p class="preview-placeholder">La direcci√≥n aparecer√° aqu√≠ despu√©s de buscarla en el mapa...</p>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div th:replace="shared/footer :: footer-pedLUz"></div>

    <!-- Notificaciones -->
    <div id="notificationContainer"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- OpenStreetMap Nominatim para geocoding -->
    <script th:src="@{/js/customer_address_form.js}"></script>
</body>
</html>